#!/usr/bin/env bash
# mirror.sh
# Mirrors a website URL to a local directory using wget.
# Usage:
#   ./mirror.sh <URL>               # basic mirror
#   ./mirror.sh <URL> -o outdir     # specify output dir
#   ./mirror.sh <URL> -c cookies.txt# load cookies (Netscape format)
#   ./mirror.sh <URL> -d            # enable debug/verbose output
#
# Example:
#   ./mirror.sh "https://challenge.example.com/path" -o ./ctf-mirror -c cookies.txt

set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: $0 <URL> [ -o output_dir ] [ -c cookies.txt ] [ -d ]"
  exit 2
fi

URL="$1"
shift

OUTDIR="mirror"
COOKIES=""
DEBUG=0
WAIT=1           # seconds between requests (be polite)
RATE="200k"      # limit rate (bytes/sec) e.g. 200k
# You can change WAIT and RATE above as desired

while (( "$#" )); do
  case "$1" in
    -o|--outdir) OUTDIR="$2"; shift 2;;
    -c|--cookies) COOKIES="$2"; shift 2;;
    -d|--debug) DEBUG=1; shift;;
    --wait) WAIT="$2"; shift 2;;
    --rate) RATE="$2"; shift 2;;
    *) echo "Unknown option: $1"; exit 2;;
  esac
done

mkdir -p "$OUTDIR"

WGET_OPTS=(
  --mirror                 # recursion + timestamps + infinite recursion depth
  --convert-links          # convert links for local viewing
  --adjust-extension       # add .html to files when appropriate
  --page-requisites        # get images/CSS/JS required to display pages
  --span-hosts             # allow assets on other hosts (CDNs)
  --no-parent              # don't ascend to parent directory
  --wait="$WAIT"           # wait between requests
  --limit-rate="$RATE"     # throttle download speed
  --random-wait            # add jitter to wait (politeness)
  --no-clobber             # don't overwrite files unnecessarily
  --tries=3                # retries
  --timeout=30             # seconds
  --restrict-file-names=windows
  --adjust-extension
  --page-requisites
)

if [ "$DEBUG" -eq 1 ]; then
  WGET_OPTS+=(--verbose)
else
  WGET_OPTS+=(--quiet)
fi

if [ -n "$COOKIES" ]; then
  if [ ! -f "$COOKIES" ]; then
    echo "Cookies file not found: $COOKIES"
    exit 3
  fi
  WGET_OPTS+=(--load-cookies="$COOKIES")
fi

# run wget
echo "Mirroring $URL -> $OUTDIR"
echo "wget options: ${WGET_OPTS[*]}"
cd "$OUTDIR"
wget "${WGET_OPTS[@]}" "$URL"

echo
echo "Done. To serve the mirror locally run:"
echo "  cd \"$OUTDIR\"/$(echo "$URL" | sed -E 's#^https?://##' | sed 's#[:/?].*##')"
echo "  python3 -m http.server 8080"
echo "Then open http://localhost:8080 in your browser."

exit 0
